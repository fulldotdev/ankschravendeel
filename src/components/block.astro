---
import { getCollection } from "astro:content"
import type { CollectionKey } from "astro:content"
import config from "fulldev.config.json"
import { keys, omit } from "remeda"

import { getHref } from "@/lib/get-href"
import { getItem } from "@/lib/get-item"
import type { BlockSchema } from "@/lib/types"
import { Block as ReactBlock } from "@/components/block"

type Props = BlockSchema

const { form, collection, ...props } = Astro.props
const collectionKeys = keys(config)

// fetch all paths and put into the items array
const items = (
  await Promise.all(
    collectionKeys.map(async (collectionKey) => {
      const paths = props[collectionKey]
      if (!paths) return undefined
      return Promise.all(paths.map(getItem))
    })
  )
)
  .flat()
  .filter((item) => item !== undefined)

// get all items in a collection
const collectionItems =
  collection &&
  (await getCollection(collection as CollectionKey)).map((entry) => ({
    href: getHref(entry),
    ...entry.data,
  }))

// get form by path
const formItem = form && getItem(form)
---

<ReactBlock
  client:load
  items={[...items, ...(collectionItems ?? [])]}
  form={formItem}
  {...omit(props, collectionKeys)}
/>
